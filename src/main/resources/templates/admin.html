<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - PanAfricanMail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="bg-white shadow-md py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="/" class="navbar-brand flex items-center text-blue-600">
                <i class="fa-solid fa-briefcase-medical mr-2"></i>
                <span>PanAfrican<span class="text-orange-500">Mail</span></span>
            </a>
            <div class="flex items-center space-x-6">
                <a href="/" class="text-gray-700 hover:text-blue-600 transition"><i class="fa-solid fa-home mr-1"></i>
                    Home</a>
                <a href="/create-post" class="text-gray-700 hover:text-blue-600 transition"><i
                        class="fa-solid fa-plus mr-1"></i> Create Post</a>
            </div>
        </div>
    </nav>

    <!-- Admin Dashboard -->
    <div class="max-w-5xl mx-auto mt-10 bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-6">Admin Dashboard</h1>

        <!-- Tabs -->
        <div class="flex border-b mb-6">
            <button class="w-1/3 py-3 text-center font-medium tab-active admin-tab-btn" data-tab="users">ðŸ‘¥
                Users</button>
            <button class="w-1/3 py-3 text-center font-medium admin-tab-btn" data-tab="job-posts">ðŸ’¼ Job Posts</button>
            <button class="w-1/3 py-3 text-center font-medium admin-tab-btn" data-tab="story-posts">ðŸ“š Story
                Posts</button>
        </div>

        <!-- Search -->
        <div class="mb-6">
            <input id="admin-search" type="text" placeholder="Search..." class="w-full px-4 py-2 border rounded" />
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="admin-content-tab">
            <table class="w-full table-auto text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left">Username</th>
                        <th class="px-4 py-2 text-left">Email</th>
                        <th class="px-4 py-2 text-left">Presence</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 text-sm" th:if="${not #lists.isEmpty(users)}">
                    <tr th:each="user : ${users}" class="border-t">
                        <td class="px-4 py-2" th:text="${user.username}">johndoe</td>
                        <td class="px-4 py-2" th:text="${user.email}">john@example.com</td>
                        <td class="px-4 py-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full"
                                th:text="${user.email}">User</span>
                        </td>
                        <td class="px-4 py-2">
                            <span
                                th:classappend="${user.email} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                class="text-xs px-2 py-1 rounded-full"
                                th:text="${user.email} ? 'Active' : 'Inactive'">Active</span>
                        </td>
                        <td class="px-4 py-2">
                            <button class="text-yellow-500 hover:text-yellow-700 mr-2">
                                <i class="fa-solid fa-ban"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Job Posts Tab -->
        <div id="job-posts-tab" class="admin-content-tab hidden">
            <!-- <div class="border rounded-lg p-4 mb-4">
        <div class="flex justify-between">
          <h3 class="font-semibold text-lg">Senior Software Engineer</h3>
          <button class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div class="text-gray-500 text-sm mb-2">TechCorp â€¢ San Francisco, CA â€¢ Posted by johndoe</div>
        <p class="text-gray-700 mb-3">We're seeking an experienced software engineer to lead development...</p>
        <div class="text-sm text-gray-500">Posted 3 days ago</div>
      </div> -->
            <div id="jobs-container" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <!-- Jobs will be inserted here -->
            </div>
        </div>

        <!-- Story Posts Tab -->
        <div id="story-posts-tab" class="admin-content-tab hidden">
            <!-- <div class="border rounded-lg p-4 mb-4">
        <div class="flex justify-between">
          <h3 class="font-semibold text-lg">How I Got My Dream Job</h3>
          <button class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div class="text-gray-500 text-sm mb-2">By Anonymous â€¢ 1 week ago</div>
        <p class="text-gray-700 mb-3">After several failed interviews, I changed my strategy and landed my dream job...</p>
      </div> -->
            <div id="stories-container" class="grid gap-4 max-w-full ">

                <!-- Stories will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">&copy; 2025 PanAfricanMail. All rights reserved.</p>
        </div>
    </footer>

    <!-- Script -->
    <script>
        const tabs = document.querySelectorAll('.admin-tab-btn');
        const contents = document.querySelectorAll('.admin-content-tab');

        tabs.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(btn => btn.classList.remove('tab-active'));

                // Hide all content tabs
                contents.forEach(content => content.classList.add('hidden'));

                // Activate selected
                const tabId = button.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.remove('hidden');
                button.classList.add('tab-active');
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();

                const usersTableBody = document.querySelector("#users-tab table tbody");
                usersTableBody.innerHTML = ""; // Clear old rows

                users.forEach(user => {
                    const row = document.createElement("tr");
                    row.classList.add("border-t");
                    row.innerHTML = `
                <td class="px-4 py-2">${user.username}</td>
                <td class="px-4 py-2">${user.email}</td>
                <td class="px-4 py-2">
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                        ${user.role || 'N/A'}
                    </span>
                </td>
                <td class="px-4 py-2">
                    <span class="text-xs px-2 py-1 rounded-full ${user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${user.active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="px-4 py-2">
                    <button class="text-yellow-500 hover:text-yellow-700 mr-2" title="Ban User">
                        <i class="fa-solid fa-ban"></i>
                    </button>
                    <button class="delete-user-btn text-red-500 hover:text-red-700" title="Delete User" data-id="${user.id}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
                    usersTableBody.appendChild(row);
                });

                // Bind delete buttons
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const userId = btn.getAttribute('data-id');

                        Swal.fire({
                            title: 'Are you sure?',
                            text: 'This user will be permanently deleted.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete'
                        }).then(async (result) => {
                            if (result.isConfirmed) {
                                const deleted = await deleteUser(userId);
                                if (deleted) {
                                    Swal.fire({
                                        title: 'Deleted!',
                                        text: 'The user has been deleted successfully.',
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                    loadUsers(); // refresh list
                                }
                            }
                        });
                    });
                });

            } catch (error) {
                console.error("Failed to load users:", error);
            }
        }

        async function deleteUser(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete user: HTTP ${response.status}`);
                }

                console.log(`User ${userId} deleted`);
                return true;
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Failed to delete user.', 'error');
                return false;
            }
        }

        window.addEventListener("DOMContentLoaded", loadUsers);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobsData = await response.json();
                renderJobs(jobsData);
            } catch (error) {
                console.error("Failed to load jobs:", error);
            }
        }

        function renderJobs(jobsData) {
            const container = document.getElementById('jobs-container');
            container.innerHTML = '';

            jobsData.forEach(job => {
                const jobCard = `
            <div class="border rounded-lg p-4 mb-4">
                <div class="flex justify-between">
                    <h3 class="font-semibold text-lg">${job.jobTitle}</h3>
                    <button class="delete-job-btn text-red-500 hover:text-red-700" 
                            title="Delete Job" 
                            data-id="${job.postId}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div class="text-gray-500 text-sm mb-2">
                    ${job.company} â€¢ ${job.location} â€¢ Posted by ${job.postedBy || 'Unknown'}
                </div>
                <p class="text-gray-700 mb-3 break-all w-full" style="white-space: normal;">
  ${job.jobDescription}
</p>

                <div class="text-sm text-gray-500">
                    Posted ${job.postedAgo || 'recently'}
                </div>
            </div>
        `;
                container.innerHTML += jobCard;
            });

            // Attach delete event after rendering
            document.querySelectorAll('.delete-job-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');

                    Swal.fire({
                        title: 'Are you sure?',
                        text: 'This job will be permanently deleted.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete it!'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const deleted = await deleteJob(id);
                            if (deleted) {
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: 'The job has been deleted successfully.',
                                    icon: 'success',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                loadJobs(); // refresh list
                            }
                        }
                    });
                });
            });
        }

        async function deleteJob(postId) {
            try {
                const response = await fetch(`/api/jobs/${postId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete job: HTTP ${response.status}`);
                }

                console.log(`Job ${postId} deleted`);
                return true;
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Failed to delete job.', 'error');
                return false;
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            loadJobs();
            const jobTab = document.querySelector('[data-tab="job-posts"]');
            if (jobTab) jobTab.click();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        async function loadStories() {
            try {
                const response = await fetch('/api/stories');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const text = await response.text();
                if (!text) {
                    console.warn("No data returned from /api/stories");
                    renderStories([]);
                    return;
                }

                const storiesData = JSON.parse(text);
                renderStories(storiesData);
            } catch (error) {
                console.error("Failed to load stories:", error);
            }
        }

        function renderStories(storiesData) {
            console.log("Stories data from API:", storiesData);

            const container = document.getElementById('stories-container');
            container.innerHTML = '';

            if (!storiesData || storiesData.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">No stories available at the moment.</p>`;
                return;
            }

            storiesData.forEach(story => {
             const storyCard = `
  <div class="border rounded-lg p-4 mb-4 bg-white shadow-sm hover:shadow-md transition max-w-full w-full break-words">
    <div class="flex justify-between">
      <h3 class="font-semibold text-lg">${story.title}</h3>
      <button class="delete-story-btn text-red-500 hover:text-red-700" 
              title="Delete Story" 
              data-id="${story.postId}">
          <i class="fa-solid fa-trash"></i>
      </button>
    </div>
    <div class="text-gray-500 text-sm mb-2">
      By ${story.author || 'Unknown'} â€¢ ${story.date || 'Recently'}
    </div>
    <p class="text-gray-700 mb-3 whitespace-pre-wrap break-words max-w-full" style="overflow-wrap: break-word;">
      ${story.content || ''}
    </p>
  </div>
`;



container.innerHTML += storyCard;
            });

            // Bind delete buttons
            document.querySelectorAll('.delete-story-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');

                    Swal.fire({
                        title: 'Are you sure?',
                        text: 'This story will be permanently deleted.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes, delete it!'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const deleted = await deleteStory(id);
                            if (deleted) {
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: 'The story has been deleted successfully.',
                                    icon: 'success',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                loadStories(); // refresh list
                            }
                        }
                    });
                });
            });
        }

        async function deleteStory(postId) {
            try {
                const response = await fetch(`/api/stories/${postId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete story: HTTP ${response.status}`);
                }

                console.log(`Story ${postId} deleted`);
                return true;
            } catch (error) {
                console.error(error);
                Swal.fire('Error', 'Failed to delete story.', 'error');
                return false;
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            const storyTab = document.querySelector('[data-tab="story-posts"]');
            let storiesLoaded = false;

            if (storyTab) {
                storyTab.addEventListener('click', () => {
                    if (!storiesLoaded) {
                        loadStories();
                        storiesLoaded = true;
                    }
                });
            }
        });
    </script>

    <script>
        document.getElementById('admin-search').addEventListener('input', function () {
            const query = this.value.toLowerCase();

            // Find which tab is active
            const activeTab = document.querySelector('.admin-tab-btn.tab-active').getAttribute('data-tab');

            if (activeTab === 'users') {
                // Filter rows in the users table
                document.querySelectorAll('#users-tab tbody tr').forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
                });

            } else if (activeTab === 'job-posts') {
                // Filter job cards
                document.querySelectorAll('#jobs-container > div').forEach(card => {
                    card.style.display = card.innerText.toLowerCase().includes(query) ? '' : 'none';
                });

            } else if (activeTab === 'story-posts') {
                // Filter story cards
                document.querySelectorAll('#stories-container > div').forEach(card => {
                    card.style.display = card.innerText.toLowerCase().includes(query) ? '' : 'none';
                });
            }
        });
    </script>



</body>

</html>